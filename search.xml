<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>20200324_Flask工程模式注册日志</title>
      <link href="/2020/04/10/20200324_Flask%E5%B7%A5%E7%A8%8B%E6%A8%A1%E5%BC%8F%E6%B3%A8%E5%86%8C%E6%97%A5%E5%BF%97/"/>
      <url>/2020/04/10/20200324_Flask%E5%B7%A5%E7%A8%8B%E6%A8%A1%E5%BC%8F%E6%B3%A8%E5%86%8C%E6%97%A5%E5%BF%97/</url>
      
        <content type="html"><![CDATA[<h1 id="Flask-工厂模式注册初始化logger"><a href="#Flask-工厂模式注册初始化logger" class="headerlink" title="Flask 工厂模式注册初始化logger"></a>Flask 工厂模式注册初始化logger</h1><h4 id="工厂模式的意义"><a href="#工厂模式的意义" class="headerlink" title="工厂模式的意义"></a>工厂模式的意义</h4><p>引用官方解释：</p><blockquote><p>If you are already using packages and blueprints for your application     (Modular Applications with Blueprints) there are a couple of really nice ways to further improve the experience. A common pattern is creating the application object when the blueprint is imported. But if you move the creation of this object into a function, you can then create multiple instances of this app later.  </p><p>So why would you want to do this?</p><ol><li>Testing. You can have instances of the application with different settings to test every case.  </li><li>Multiple instances. Imagine you want to run different versions of the same application. Of course you could have multiple instances with different configs set up in your webserver, but if you use factories, you can have multiple instances of the same application running in the same application process which can be handy.</li></ol></blockquote><p>大概意思是：</p><ol><li>为了方便测试，你可以随心所欲的切换不同的配置实例来测试你的用例。</li><li>相同的应用，你可以利用不同的配置实例来进行初始化，达到运行不同版本应用的目的。</li></ol><p>官方实例的应用(autoapp.py)：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">(config_filename)</span>:</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_pyfile(config_filename)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> yourapplication.model <span class="keyword">import</span> db</span><br><span class="line">    db.init_app(app)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> yourapplication.views.admin <span class="keyword">import</span> admin</span><br><span class="line">    <span class="keyword">from</span> yourapplication.views.frontend <span class="keyword">import</span> frontend</span><br><span class="line">    app.register_blueprint(admin)</span><br><span class="line">    app.register_blueprint(frontend)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure><h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>为了能让我们的日志初始化添加如下代码(autoapp.py)：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_logging</span><span class="params">(app)</span>:</span></span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_PATH"</span>, <span class="string">"application.log"</span>)</span><br><span class="line"></span><br><span class="line">    log_formatter = <span class="string">"%(asctime)s [%(thread)d:%(threadName)s] %(filename)s:%(module)s:%(funcName)s in %(lineno)d] [%(levelname)s]: %(message)s"</span></span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_FORMATTER"</span>, log_formatter)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_MAX_BYTES"</span>, <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_BACKUP_COUNT"</span>, <span class="number">10</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_INTERVAL"</span>, <span class="number">1</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_WHEN"</span>, <span class="string">"D"</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_LEVEL"</span>, <span class="string">"INFO"</span>)</span><br><span class="line"></span><br><span class="line">    formatter = logging.Formatter(app.config[<span class="string">"LOG_FORMATTER"</span>])</span><br><span class="line">    <span class="comment"># 将日志输出到文件</span></span><br><span class="line">    <span class="comment"># 指定间隔时间自动生成文件的处理器</span></span><br><span class="line">    <span class="comment"># 实例化TimedRotatingFileHandler</span></span><br><span class="line">    <span class="comment"># interval是时间间隔，</span></span><br><span class="line">    <span class="comment"># backupCount是备份文件的个数，如果超过这个个数，就会自动删除</span></span><br><span class="line">    <span class="comment"># when是间隔的时间单位，单位有以下几种：</span></span><br><span class="line">    <span class="comment"># S 秒</span></span><br><span class="line">    <span class="comment"># M 分</span></span><br><span class="line">    <span class="comment"># H 小时、</span></span><br><span class="line">    <span class="comment"># D 天、</span></span><br><span class="line">    <span class="comment"># W 每星期（interval==0时代表星期一）</span></span><br><span class="line">    <span class="comment"># midnight 每天凌晨</span></span><br><span class="line">    timed_rotating_file_handler = TimedRotatingFileHandler(</span><br><span class="line">        filename=app.config[<span class="string">"LOG_PATH"</span>],</span><br><span class="line">        interval=app.config[<span class="string">"LOG_INTERVAL"</span>],</span><br><span class="line">        when=app.config[<span class="string">"LOG_WHEN"</span>],</span><br><span class="line">        backupCount=app.config[<span class="string">"LOG_BACKUP_COUNT"</span>],</span><br><span class="line">        encoding=<span class="string">"utf-8"</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    timed_rotating_file_handler.setFormatter(formatter)  <span class="comment"># 设置文件里写入的格式</span></span><br><span class="line">    timed_rotating_file_handler.setLevel(app.config[<span class="string">"LOG_LEVEL"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># StreamHandler</span></span><br><span class="line">    stream_handler = StreamHandler()</span><br><span class="line">    stream_handler.setFormatter(formatter)</span><br><span class="line">    stream_handler.setLevel(app.config[<span class="string">"LOG_LEVEL"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SMTPHandler</span></span><br><span class="line">    mail_handler = DelaySMTPHandler(</span><br><span class="line">        mailhost=app.config[<span class="string">"MAILHOST"</span>],</span><br><span class="line">        credentials=app.config[<span class="string">"CREDENTIALS"</span>],</span><br><span class="line">        fromaddr=app.config[<span class="string">"FROMADDR"</span>],</span><br><span class="line">        toaddrs=app.config[<span class="string">"TOADDRS"</span>],</span><br><span class="line">        subject=app.config[<span class="string">"SUBJECT"</span>],</span><br><span class="line">    )</span><br><span class="line">    mail_handler.setLevel(logging.ERROR)</span><br><span class="line">    mail_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除默认的handler</span></span><br><span class="line">    <span class="comment"># app.logger.removeHandler(default_handler)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置logger</span></span><br><span class="line">    <span class="keyword">for</span> logger <span class="keyword">in</span> (</span><br><span class="line">        app.logger,</span><br><span class="line">        logging.getLogger(<span class="string">"sqlalchemy"</span>),</span><br><span class="line">        logging.getLogger(<span class="string">"werkzeug"</span>),</span><br><span class="line">    ):</span><br><span class="line">        logger.addHandler(stream_handler)</span><br><span class="line">        logger.addHandler(timed_rotating_file_handler)</span><br><span class="line">        <span class="keyword">if</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"production"</span>:</span><br><span class="line">            logger.addHandler(mail_handler)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set logger for elk</span></span><br><span class="line">    <span class="comment"># stash_handler = logstash.LogstashHandler(</span></span><br><span class="line">    <span class="comment">#     app.config.get('ELK_HOST'),</span></span><br><span class="line">    <span class="comment">#     app.config.get('ELK_PORT')</span></span><br><span class="line">    <span class="comment"># )</span></span><br><span class="line">    <span class="comment"># root_logger.addHandler(stashHandler)</span></span><br></pre></td></tr></table></figure><h4 id="使用log"><a href="#使用log" class="headerlink" title="使用log"></a>使用log</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from flask import current_app</span><br><span class="line"></span><br><span class="line">current_app.logger.info(&quot;hello world&quot;)</span><br></pre></td></tr></table></figure><h4 id="这样做的好处"><a href="#这样做的好处" class="headerlink" title="这样做的好处"></a>这样做的好处</h4><ol><li>可以多环境随意切换配置，而不用更改代码</li><li>日志配置在<code>setting.py</code>统一配置管理</li></ol><h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><p>autoapp.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">(config_filename)</span>:</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_pyfile(config_filename)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> yourapplication.model <span class="keyword">import</span> db</span><br><span class="line">    db.init_app(app)</span><br><span class="line">    </span><br><span class="line">    register_logging(app)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> yourapplication.views.admin <span class="keyword">import</span> admin</span><br><span class="line">    <span class="keyword">from</span> yourapplication.views.frontend <span class="keyword">import</span> frontend</span><br><span class="line">    app.register_blueprint(admin)</span><br><span class="line">    app.register_blueprint(frontend)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_logging</span><span class="params">(app)</span>:</span></span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_PATH"</span>, <span class="string">"application.log"</span>)</span><br><span class="line"></span><br><span class="line">    log_formatter = <span class="string">"%(asctime)s [%(thread)d:%(threadName)s] %(filename)s:%(module)s:%(funcName)s in %(lineno)d] [%(levelname)s]: %(message)s"</span></span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_FORMATTER"</span>, log_formatter)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_MAX_BYTES"</span>, <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_BACKUP_COUNT"</span>, <span class="number">10</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_INTERVAL"</span>, <span class="number">1</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_WHEN"</span>, <span class="string">"D"</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_LEVEL"</span>, <span class="string">"INFO"</span>)</span><br><span class="line"></span><br><span class="line">    formatter = logging.Formatter(app.config[<span class="string">"LOG_FORMATTER"</span>])</span><br><span class="line">    <span class="comment"># 将日志输出到文件</span></span><br><span class="line">    <span class="comment"># 指定间隔时间自动生成文件的处理器</span></span><br><span class="line">    <span class="comment"># 实例化TimedRotatingFileHandler</span></span><br><span class="line">    <span class="comment"># interval是时间间隔，</span></span><br><span class="line">    <span class="comment"># backupCount是备份文件的个数，如果超过这个个数，就会自动删除</span></span><br><span class="line">    <span class="comment"># when是间隔的时间单位，单位有以下几种：</span></span><br><span class="line">    <span class="comment"># S 秒</span></span><br><span class="line">    <span class="comment"># M 分</span></span><br><span class="line">    <span class="comment"># H 小时、</span></span><br><span class="line">    <span class="comment"># D 天、</span></span><br><span class="line">    <span class="comment"># W 每星期（interval==0时代表星期一）</span></span><br><span class="line">    <span class="comment"># midnight 每天凌晨</span></span><br><span class="line">    timed_rotating_file_handler = TimedRotatingFileHandler(</span><br><span class="line">        filename=app.config[<span class="string">"LOG_PATH"</span>],</span><br><span class="line">        interval=app.config[<span class="string">"LOG_INTERVAL"</span>],</span><br><span class="line">        when=app.config[<span class="string">"LOG_WHEN"</span>],</span><br><span class="line">        backupCount=app.config[<span class="string">"LOG_BACKUP_COUNT"</span>],</span><br><span class="line">        encoding=<span class="string">"utf-8"</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    timed_rotating_file_handler.setFormatter(formatter)  <span class="comment"># 设置文件里写入的格式</span></span><br><span class="line">    timed_rotating_file_handler.setLevel(app.config[<span class="string">"LOG_LEVEL"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># StreamHandler</span></span><br><span class="line">    stream_handler = StreamHandler()</span><br><span class="line">    stream_handler.setFormatter(formatter)</span><br><span class="line">    stream_handler.setLevel(app.config[<span class="string">"LOG_LEVEL"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SMTPHandler</span></span><br><span class="line">    mail_handler = DelaySMTPHandler(</span><br><span class="line">        mailhost=app.config[<span class="string">"MAILHOST"</span>],</span><br><span class="line">        credentials=app.config[<span class="string">"CREDENTIALS"</span>],</span><br><span class="line">        fromaddr=app.config[<span class="string">"FROMADDR"</span>],</span><br><span class="line">        toaddrs=app.config[<span class="string">"TOADDRS"</span>],</span><br><span class="line">        subject=app.config[<span class="string">"SUBJECT"</span>],</span><br><span class="line">    )</span><br><span class="line">    mail_handler.setLevel(logging.ERROR)</span><br><span class="line">    mail_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除默认的handler</span></span><br><span class="line">    <span class="comment"># app.logger.removeHandler(default_handler)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置logger</span></span><br><span class="line">    <span class="keyword">for</span> logger <span class="keyword">in</span> (</span><br><span class="line">        app.logger,</span><br><span class="line">        logging.getLogger(<span class="string">"sqlalchemy"</span>),</span><br><span class="line">        logging.getLogger(<span class="string">"werkzeug"</span>),</span><br><span class="line">    ):</span><br><span class="line">        logger.addHandler(stream_handler)</span><br><span class="line">        logger.addHandler(timed_rotating_file_handler)</span><br><span class="line">        <span class="keyword">if</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"production"</span>:</span><br><span class="line">            logger.addHandler(mail_handler)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set logger for elk</span></span><br><span class="line">    <span class="comment"># stash_handler = logstash.LogstashHandler(</span></span><br><span class="line">    <span class="comment">#     app.config.get('ELK_HOST'),</span></span><br><span class="line">    <span class="comment">#     app.config.get('ELK_PORT')</span></span><br><span class="line">    <span class="comment"># )</span></span><br><span class="line">    <span class="comment"># root_logger.addHandler(stashHandler)</span></span><br></pre></td></tr></table></figure><p>settings.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""Application configuration.</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">BASE_DIR = os.path.dirname(__file__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment"># Base settings #################################################</span></span><br><span class="line">    DEBUG = <span class="literal">False</span></span><br><span class="line">    TESTING = <span class="literal">False</span></span><br><span class="line">    SECRET_KEY = <span class="string">""</span></span><br><span class="line">    BUNDLE_ERRORS = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志配置 ###############################################################</span></span><br><span class="line">    LOG_PATH = os.path.join(BASE_DIR, <span class="string">"logs"</span>, <span class="string">"falling-wind-service.log"</span>)</span><br><span class="line">    LOG_FORMATTER = (</span><br><span class="line">        <span class="string">"%(asctime)s [%(name)s] [%(thread)d:%(threadName)s] "</span></span><br><span class="line">        <span class="string">"%(filename)s:%(module)s:%(funcName)s "</span></span><br><span class="line">        <span class="string">"in %(lineno)d] "</span></span><br><span class="line">        <span class="string">"[%(levelname)s]: %(message)s"</span></span><br><span class="line">    )</span><br><span class="line">    LOG_MAX_BYTES = <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 日志文件大小</span></span><br><span class="line">    LOG_BACKUP_COUNT = <span class="number">10</span>  <span class="comment"># 备份文件数量</span></span><br><span class="line">    LOG_INTERVAL = <span class="number">1</span></span><br><span class="line">    LOG_WHEN = <span class="string">"D"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据库配置 ####################################################</span></span><br><span class="line">    SQLALCHEMY_ENGINE_OPTIONS = &#123;</span><br><span class="line">        <span class="string">"pool_timeout"</span>: <span class="number">10</span>,  <span class="comment"># 默认链接超时时长</span></span><br><span class="line">        <span class="string">"pool_size"</span>: <span class="number">10</span>,  <span class="comment"># 数据库链接池大小</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 提供多库链接 使用其他库进行链接的时候需要使用bind指定那个库使用</span></span><br><span class="line">    SQLALCHEMY_BINDS = &#123;&#125;</span><br><span class="line">    SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Celery ##################################################################</span></span><br><span class="line">    enable_utc = <span class="literal">True</span></span><br><span class="line">    timezone = <span class="string">"Asia/Shanghai"</span></span><br><span class="line">    <span class="comment"># or the actual content-type (MIME)</span></span><br><span class="line">    accept_content = [<span class="string">"application/json"</span>]</span><br><span class="line">    <span class="comment"># or the actual content-type (MIME)</span></span><br><span class="line">    result_accept_content = [<span class="string">"application/json"</span>]</span><br><span class="line">    include = [<span class="string">"app_tasks.user_tasks"</span>]</span><br><span class="line">    result_expires = <span class="number">3600</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># JWT ####################################################################</span></span><br><span class="line">    JWT_SECRET_KEY = <span class="string">""</span></span><br><span class="line">    <span class="comment"># JWT_BLACKLIST_ENABLED = False</span></span><br><span class="line">    <span class="comment"># JWT_BLACKLIST_TOKEN_CHECKS = ['access', 'refresh']</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pro</span><span class="params">(Config)</span>:</span></span><br><span class="line">    ENV = <span class="string">"product"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志 ##################################################################</span></span><br><span class="line">    LOG_PATH = <span class="string">"your application log path"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># DB ##################################################################</span></span><br><span class="line">    DB_HOST = <span class="string">""</span></span><br><span class="line">    DB_PORT = <span class="number">3306</span></span><br><span class="line">    DB_DATABASE = <span class="string">""</span></span><br><span class="line">    DB_USER = <span class="string">""</span></span><br><span class="line">    DB_PASSWORD = <span class="string">""</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = <span class="string">"mysql+pymysql://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;"</span>.format(</span><br><span class="line">        DB_USER, DB_PASSWORD, DB_HOST, DB_PORT, DB_DATABASE</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Redis ####################################################</span></span><br><span class="line">    REDIS_URL = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Mail ########################################################</span></span><br><span class="line">    MAIL_SERVER = <span class="string">"smtp.qq.com"</span></span><br><span class="line">    MAIL_PORT = <span class="number">465</span></span><br><span class="line">    MAIL_USE_SSL = <span class="literal">True</span></span><br><span class="line">    MAIL_USERNAME = <span class="string">""</span></span><br><span class="line">    MAIL_PASSWORD = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Celery ###########################################################</span></span><br><span class="line">    <span class="comment"># Broker settings.</span></span><br><span class="line">    broker_url = <span class="string">""</span></span><br><span class="line">    <span class="comment"># Using the redis to store task state and results.</span></span><br><span class="line">    result_backend = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># JWT ###############################################################</span></span><br><span class="line">    <span class="comment"># JWT_ACCESS_TOKEN_EXPIRES = 60 * 60</span></span><br><span class="line">    JWT_SECRET_KEY = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># SMTPHandler ######################################################</span></span><br><span class="line">    MAILHOST = (<span class="string">"smtp.qq.com"</span>, <span class="number">465</span>)</span><br><span class="line">    CREDENTIALS = (<span class="string">""</span>, <span class="string">""</span>)</span><br><span class="line">    FROMADDR = <span class="string">""</span></span><br><span class="line">    TOADDRS = [<span class="string">""</span>]</span><br><span class="line">    SUBJECT = <span class="string">""</span></span><br><span class="line">    SECURE = (<span class="string">"SSL"</span>,)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dev</span><span class="params">(Config)</span>:</span></span><br><span class="line">    DEBUG = <span class="literal">True</span></span><br><span class="line">    ENV = <span class="string">"dev"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志 ##################################################################</span></span><br><span class="line">    LOG_PATH = <span class="string">"your path"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># DB ####################################################################</span></span><br><span class="line">    DB_HOST = <span class="string">"localhost"</span></span><br><span class="line">    DB_PORT = <span class="number">3306</span></span><br><span class="line">    DB_DATABASE = <span class="string">""</span></span><br><span class="line">    DB_USER = <span class="string">""</span></span><br><span class="line">    DB_PASSWORD = <span class="string">""</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = <span class="string">"mysql+pymysql://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;"</span>.format(</span><br><span class="line">        DB_USER, DB_PASSWORD, DB_HOST, DB_PORT, DB_DATABASE</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Redis ####################################################</span></span><br><span class="line">    REDIS_URL = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Mail ########################################################</span></span><br><span class="line">    MAIL_SERVER = <span class="string">"smtp.qq.com"</span></span><br><span class="line">    MAIL_PORT = <span class="number">25</span></span><br><span class="line">    MAIL_USE_TLS = <span class="literal">True</span></span><br><span class="line">    MAIL_USERNAME = <span class="string">""</span></span><br><span class="line">    MAIL_PASSWORD = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Celery ###################################################################</span></span><br><span class="line">    <span class="comment"># Broker settings.</span></span><br><span class="line">    broker_url = <span class="string">""</span></span><br><span class="line">    <span class="comment"># Using the redis to store task state and results.</span></span><br><span class="line">    result_backend = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># JWT ###############################################################</span></span><br><span class="line">    JWT_ACCESS_TOKEN_EXPIRES = <span class="number">60</span> * <span class="number">60</span></span><br><span class="line">    JWT_SECRET_KEY = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># SMTPHandler ######################################################</span></span><br><span class="line">    MAILHOST = (<span class="string">"smtp.qq.com"</span>, <span class="number">465</span>)</span><br><span class="line">    CREDENTIALS = (<span class="string">""</span>, <span class="string">""</span>)</span><br><span class="line">    FROMADDR = <span class="string">""</span></span><br><span class="line">    TOADDRS = [<span class="string">""</span>]</span><br><span class="line">    SUBJECT = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">(Config)</span>:</span></span><br><span class="line">    TESTING = <span class="literal">True</span></span><br><span class="line">    DEBUG = <span class="literal">True</span></span><br><span class="line">    ENV = <span class="string">"test"</span></span><br></pre></td></tr></table></figure><p>app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""Create an application instance."""</span></span><br><span class="line"><span class="keyword">from</span> autoapp <span class="keyword">import</span> create_app</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> extensions <span class="keyword">import</span> celery</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"development"</span>:</span><br><span class="line">    app = create_app(<span class="string">"settings.Dev"</span>)</span><br><span class="line"><span class="keyword">elif</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"production"</span>:</span><br><span class="line">    app = create_app(<span class="string">"settings.Pro"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> EnvironmentError(<span class="string">"Please set FLASK_ENV ！！！"</span>)</span><br><span class="line"></span><br><span class="line">celery = celery</span><br></pre></td></tr></table></figure><h4 id="运行flask"><a href="#运行flask" class="headerlink" title="运行flask"></a>运行flask</h4><p>windows</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ set FLASK_ENV&#x3D;development</span><br><span class="line">$ flask run</span><br></pre></td></tr></table></figure><p>Linux</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ export FLASK_ENV&#x3D;development</span><br><span class="line">$ flask run</span><br></pre></td></tr></table></figure><p>Enjoy your code!</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>20200331_ELKF环境搭建总结</title>
      <link href="/2020/04/10/20200331_ELKF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%80%BB%E7%BB%93/"/>
      <url>/2020/04/10/20200331_ELKF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h1 id="ELK-环境搭建"><a href="#ELK-环境搭建" class="headerlink" title="ELK 环境搭建"></a>ELK 环境搭建</h1><h2 id="开始动手前的说明"><a href="#开始动手前的说明" class="headerlink" title="开始动手前的说明"></a>开始动手前的说明</h2><p>我搭建这一套环境的时候是基于docker搭建的，用到了docker-compose，所以开始前要先安装好<code>docker</code> 、 <code>docker-compose</code>，并简单的了解<code>docker</code> 、 <code>docker-compose</code>的用法。</p><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>ELK 是什么？<br>ELK 指：ElasticSearch + Logstash + Kibana</p><p>ELK 用来干什么？<br>ELK 可以用来收集日志并进行日志分析，实现日志的统一管理，帮助开发人员和运维人员快速分析日志，快速发现问题。</p><p>当然它还有很多非常多实用功能，需要您去自行挖掘。</p><p>这里使用<code>Filebeat</code>进行日志收集并将收集上来的日志发送给<code>ELK</code>。</p><p><strong>es:</strong></p><blockquote><p>Elasticsearch 是一个分布式、RESTful 风格的搜索和数据分析引擎。</p></blockquote><p><strong>kibana:</strong></p><blockquote><p>Kibana 是通向 Elastic 产品集的窗口。 它可以在 Elasticsearch 中对数据进行视觉探索和实时分析。</p></blockquote><p><strong>logstash:</strong></p><blockquote><p>Logstash 是开源的服务器端数据处理管道，能够同时从多个来源采集数据，转换数据，然后将数据发送到您最喜欢的“存储库”中</p></blockquote><p><strong>filebeat:</strong></p><blockquote><p>轻量级收集日志的服务，并且可以将收集的日志发送给 es、logstash、kafka、redis</p></blockquote><p>filebeat 概览图<br><img src="https://www.elastic.co/guide/en/beats/filebeat/current/images/filebeat.png" alt=""></p><h3 id="ELK日志数据收集时序图"><a href="#ELK日志数据收集时序图" class="headerlink" title="ELK日志数据收集时序图"></a>ELK日志数据收集时序图</h3><p><img src="https://pic.downk.cc/item/5e7ea7c8504f4bcb04fda1aa.png" alt=""></p><p>接下来开始动手操作。</p><p>准备工作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ELK_pro</span><br><span class="line">$ <span class="built_in">cd</span> ELK_pro</span><br><span class="line">$ touch docker-compose.yml</span><br><span class="line">$ touch Dockerfile</span><br><span class="line">$ touch filebeat.yml</span><br><span class="line">$ touch kibana.yml</span><br><span class="line">$ touch logstash-pipeline.conf</span><br><span class="line">$ touch logstash.yml</span><br></pre></td></tr></table></figure><h3 id="ElasticSearch-环境搭建"><a href="#ElasticSearch-环境搭建" class="headerlink" title="ElasticSearch 环境搭建"></a>ElasticSearch 环境搭建</h3><p>我是参考官网的例子直接写的<code>docker-compose.yml</code>，然后做了小的改动。下面是我改动之后的配置：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">es01:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.6.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es01</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es01</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-docker-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01,es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.authc.accept_default_password=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.verification_mode=certificate</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.keystore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.truststore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">data01:/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./elastic-certificates.p12:/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9200</span><span class="string">:9200</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">falling_wind</span></span><br><span class="line">  <span class="attr">es02:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.6.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es02</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es02</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-docker-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es01,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01,es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.authc.accept_default_password=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.verification_mode=certificate</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.keystore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.truststore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">data02:/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./elastic-certificates.p12:/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">falling_wind</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">es03:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.6.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es03</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-docker-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es01,es02</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01,es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.authc.accept_default_password=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.verification_mode=certificate</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.keystore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.truststore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">data03:/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./elastic-certificates.p12:/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">falling_wind</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">data01:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">data02:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">data03:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">falling_wind:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><p>这个配置我是加了证书认证的。</p><p>下面请看证书生成方法：</p><ol><li><p>进入docker (es01)：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">$ docker <span class="built_in">exec</span> -it 容器ID或名称 /bin/sh</span><br></pre></td></tr></table></figure></li><li><p>生成证书并copy</p></li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> bin</span><br><span class="line">$ elasticsearch-certutil ca</span><br><span class="line">$ elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ docker cp 容器ID:/usr/share/elasticsearch/elastic-certificates.p12 .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：最后的点不要忘记了。</span></span><br></pre></td></tr></table></figure><ol start="3"><li>设置es01的密码：</li></ol><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">$ docker <span class="built_in">exec</span> -it 容器ID或名称 /bin/sh</span><br><span class="line">$ <span class="built_in">cd</span> bin</span><br><span class="line">$ elasticsearch-setup-passwords interactive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 按照提示设置密码即可</span></span><br></pre></td></tr></table></figure><h3 id="kibana-环境搭建"><a href="#kibana-环境搭建" class="headerlink" title="kibana 环境搭建"></a>kibana 环境搭建</h3><p>配置 kibana</p><p><code>docker-compose.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kibana:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">docker.elastic.co/kibana/kibana:7.6.1</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">kibana_7_61</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"5601:5601"</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./kibana.yml:/usr/share/kibana/config/kibana.yml</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">falling_wind</span></span><br><span class="line">  <span class="attr">depends_on:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">es01</span></span><br></pre></td></tr></table></figure><p><code>kibana.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">"0"</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> <span class="string">["http://172.18.114.219:9200"]</span></span><br><span class="line"><span class="attr">xpack.monitoring.ui.container.elasticsearch.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">your</span> <span class="string">username</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">your</span> <span class="string">password</span></span><br></pre></td></tr></table></figure><h4 id="logsstash-环境搭建"><a href="#logsstash-环境搭建" class="headerlink" title="logsstash 环境搭建"></a>logsstash 环境搭建</h4><p>配置logsstash</p><p><code>docker-compose.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logstash:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">docker.elastic.co/logstash/logstash:7.6.1</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">logstash_7_61</span></span><br><span class="line">  <span class="attr">ports:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">"5044:5044"</span></span><br><span class="line">  <span class="attr">volumes:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">./logstash.yml:/usr/share/logstash/config/logstash.yml</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./logstash-pipeline.conf:/usr/share/logstash/conf.d/logstash-pipeline.conf</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">falling_wind</span></span><br></pre></td></tr></table></figure><p><code>logstash.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">path.config:</span> <span class="string">/usr/share/logstash/conf.d/*.conf</span></span><br><span class="line"><span class="attr">path.logs:</span> <span class="string">/var/log/logstash</span></span><br></pre></td></tr></table></figure><p><code>logstash-pipeline.conf</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port &#x3D;&gt; 5044</span><br><span class="line">    codec &#x3D;&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port &#x3D;&gt; 8000</span><br><span class="line">    codec &#x3D;&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts &#x3D;&gt; [&quot;172.18.114.219:9200&quot;]</span><br><span class="line">    index &#x3D;&gt; &quot;falling-wind&quot;</span><br><span class="line">    user &#x3D;&gt; &quot;your username&quot;</span><br><span class="line">    password &#x3D;&gt; &quot;your password&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec &#x3D;&gt; rubydebug</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="filebeat-环境搭建"><a href="#filebeat-环境搭建" class="headerlink" title="filebeat 环境搭建"></a>filebeat 环境搭建</h3><p>配置 filebeat </p><p><code>docker-compose.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat:</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">filebeat_7_61</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">  <span class="attr">volumes:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/logs:/usr/share/filebeat/logs</span></span><br><span class="line">  <span class="attr">networks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">falling_wind</span></span><br></pre></td></tr></table></figure><p><code>Dockerfile</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FROM docker.elastic.co&#x2F;beats&#x2F;filebeat:7.6.1</span><br><span class="line">COPY filebeat.yml &#x2F;usr&#x2F;share&#x2F;filebeat&#x2F;filebeat.yml</span><br><span class="line">USER root</span><br><span class="line">RUN chown root:filebeat &#x2F;usr&#x2F;share&#x2F;filebeat&#x2F;filebeat.yml</span><br><span class="line">RUN chown root:filebeat &#x2F;usr&#x2F;share&#x2F;filebeat&#x2F;data&#x2F;meta.json</span><br></pre></td></tr></table></figure><blockquote><p>说明：官网上的Dockerfile最后还加了 <code>USER filebeat</code>，按理说应该不会出现什么问题，但是启动总是会报权限不足：<code>/usr/share/filebeat/data/meta.json</code>，所以我暂时将这一句去掉就好了。</p></blockquote><p><code>filebeat.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/filebeat/logs/falling-wind/*.log</span></span><br><span class="line">    <span class="attr">multiline.pattern:</span> <span class="string">'^[[:space:]]'</span></span><br><span class="line">    <span class="attr">multiline.negate:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">["falling-wind"]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/filebeat/logs/celery/*.log</span></span><br><span class="line">    <span class="attr">multiline.pattern:</span> <span class="string">'^[[:space:]]'</span></span><br><span class="line">    <span class="attr">multiline.negate:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">["celery"]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/filebeat/logs/gunicorn/*.log</span></span><br><span class="line">    <span class="attr">multiline.pattern:</span> <span class="string">'^[[:space:]]'</span></span><br><span class="line">    <span class="attr">multiline.negate:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">multiline.match:</span> <span class="string">after</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">["gunicorn"]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/share/filebeat/logs/supervisor/*.log</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">["supervisor"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#============================= Filebeat modules ===============================</span></span><br><span class="line"><span class="attr">filebeat.config.modules:</span></span><br><span class="line">  <span class="comment"># Glob pattern for configuration loading</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">$&#123;path.config&#125;/modules.d/*.yml</span></span><br><span class="line">  <span class="comment"># Set to true to enable config reloading</span></span><br><span class="line">  <span class="attr">reload.enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">["172.18.114.219:5044"]</span></span><br></pre></td></tr></table></figure><p><em>注意合并多行信息的配置</em>：</p><p>将堆栈信息合并：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">multiline.pattern:</span> <span class="string">'^[[:space:]]'</span></span><br><span class="line"><span class="attr">multiline.negate:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">multiline.match:</span> <span class="string">after</span></span><br></pre></td></tr></table></figure><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>一共需要的配置文件：</p><ul><li>docker-compose.yml</li><li>Dockerfile： 构建filebeat镜像</li><li>elastic-certificates.p12：证书文件</li><li>filebeat.yml</li><li>kibana.yml</li><li>logstash-pipeline.conf</li><li>logstash.yml</li></ul><p>docker-compose.yml 完整版：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">es01:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.6.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es01</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es01</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-docker-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01,es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.authc.accept_default_password=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.verification_mode=certificate</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.keystore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.truststore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">data01:/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./elastic-certificates.p12:/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9200</span><span class="string">:9200</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">falling_wind</span></span><br><span class="line">  <span class="attr">es02:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.6.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es02</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es02</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-docker-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es01,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01,es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.authc.accept_default_password=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.verification_mode=certificate</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.keystore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.truststore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">data02:/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./elastic-certificates.p12:/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">falling_wind</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">es03:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.6.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">es03</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">node.name=es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.name=es-docker-cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">discovery.seed_hosts=es01,es02</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cluster.initial_master_nodes=es01,es02,es03</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">bootstrap.memory_lock=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"ES_JAVA_OPTS=-Xms512m -Xmx512m"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.authc.accept_default_password=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.enabled=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.verification_mode=certificate</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.keystore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xpack.security.transport.ssl.truststore.path=/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">ulimits:</span></span><br><span class="line">      <span class="attr">memlock:</span></span><br><span class="line">        <span class="attr">soft:</span> <span class="number">-1</span></span><br><span class="line">        <span class="attr">hard:</span> <span class="number">-1</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">data03:/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./elastic-certificates.p12:/usr/share/elasticsearch/config/certificates/elastic-certificates.p12</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">falling_wind</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">kibana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/kibana/kibana:7.6.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">kibana_7_61</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"5601:5601"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./kibana.yml:/usr/share/kibana/config/kibana.yml</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">falling_wind</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">es01</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">logstash:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.elastic.co/logstash/logstash:7.6.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">logstash_7_61</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">"5044:5044"</span></span><br><span class="line">    <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logstash.yml:/usr/share/logstash/config/logstash.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./logstash-pipeline.conf:/usr/share/logstash/conf.d/logstash-pipeline.conf</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">falling_wind</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">filebeat:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">filebeat_7_61</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/logs:/usr/share/filebeat/logs</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">falling_wind</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">data01:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">data02:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">data03:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">local</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">falling_wind:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure><p>Enjoy your code!</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>20200414_Flask中的迭代器和生成器</title>
      <link href="/2020/04/10/20200414_Flask%E4%B8%AD%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%99%A8%E5%92%8C%E7%94%9F%E6%88%90%E5%99%A8/"/>
      <url>/2020/04/10/20200414_Flask%E4%B8%AD%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%99%A8%E5%92%8C%E7%94%9F%E6%88%90%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>面试的时候总是被问到迭代器、生成器、装饰器，一开始不知道怎么回答，然后查阅资料之后总算是有点认识了。</p><h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p>迭代器其实是一个实现了迭代器协议的容器对象。</p><p>它基于2个方法：</p><ul><li><code>__next__</code>: 返回容器的下一个元素</li><li><code>__iter__</code>: 返回迭代器本身</li></ul><p><code>range()</code>函数就是一个迭代器</p><p>接下来我模拟range写一个迭代器</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Range</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, start : int = <span class="number">0</span>, end : int = <span class="number">10</span>, step : int = <span class="number">1</span>)</span>:</span></span><br><span class="line">        self.start = start</span><br><span class="line">        self.end = end</span><br><span class="line">        self.step = step</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__next__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.start &gt; (self.end - self.step):</span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">        self.start += self.step</span><br><span class="line">        <span class="keyword">return</span> self.start</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__iter__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self</span><br></pre></td></tr></table></figure><p>测试默认值：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print([i for i in Range()])</span><br><span class="line">[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</span><br></pre></td></tr></table></figure><p>测试非默认值，设置步长为3:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print([i for i in Range(10, 50, 3)])</span><br><span class="line">[13, 16, 19, 22, 25, 28, 31, 34, 37, 40, 43, 46, 49]</span><br></pre></td></tr></table></figure><p>可见<code>Range</code>对象是一个可以迭代的对象</p><p>迭代器跟生成器一般是结合使用的。</p><h2 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h2><p>基于<code>yield</code>语句，生成器可以暂停当前执行的函数，返回<code>yield</code>当前要返回的值，并保存上下文。</p><p>例如生成可以被3整除的数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">divide_three</span><span class="params">()</span>:</span></span><br><span class="line">    a = <span class="number">3</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">yield</span> a</span><br><span class="line">        a += <span class="number">3</span></span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; res &#x3D; divide_three()</span><br><span class="line">&gt;&gt;&gt; print([next(res) for i in range(20)])</span><br><span class="line">[3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33, 36, 39, 42, 45, 48, 51, 54, 57, 60]</span><br></pre></td></tr></table></figure><p>这里调用了20次，理论上，如果你愿意，可以调用无限次，是不是很神奇。</p><p>来看看<code>divide_three</code>的类型：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print(divide_three())</span><br><span class="line">&lt;generator object divide_three at 0x1116db550&gt;</span><br></pre></td></tr></table></figure><p>现在是不是对迭代器、生成器有点感觉了。</p><p>Enjoy your code, good luck.</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>20200317_Flask怎样快速切换运行环境</title>
      <link href="/2020/04/10/20200317_Flask%E6%80%8E%E6%A0%B7%E5%BF%AB%E9%80%9F%E5%88%87%E6%8D%A2%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83/"/>
      <url>/2020/04/10/20200317_Flask%E6%80%8E%E6%A0%B7%E5%BF%AB%E9%80%9F%E5%88%87%E6%8D%A2%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h1 id="Flaks怎样快速切换运行环境配置"><a href="#Flaks怎样快速切换运行环境配置" class="headerlink" title="Flaks怎样快速切换运行环境配置"></a>Flaks怎样快速切换运行环境配置</h1><h2 id="先了解下Flask开发环境运行方式"><a href="#先了解下Flask开发环境运行方式" class="headerlink" title="先了解下Flask开发环境运行方式"></a>先了解下Flask开发环境运行方式</h2><p>参考官网链接：<a href="https://flask.palletsprojects.com/en/1.1.x/quickstart/#a-minimal-application" target="_blank" rel="noopener">https://flask.palletsprojects.com/en/1.1.x/quickstart/#a-minimal-application</a></p><p>运行app一般可以有两种方式：</p><ol><li>命令行直接运行(推荐)</li><li>运行 <code>app.py</code> 脚本</li></ol><h3 id="命令行运行"><a href="#命令行运行" class="headerlink" title="命令行运行"></a>命令行运行</h3><p>命令行运行方式： 指定app</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ export FLASK_APP&#x3D;hello.py</span><br><span class="line">$ flask run</span><br><span class="line"> * Running on http:&#x2F;&#x2F;127.0.0.1:5000&#x2F;</span><br></pre></td></tr></table></figure><p>命令行运行方式： 指定ENV环境，(记住这种方式，后面会用到)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ export FLASK_APP&#x3D;hello.py</span><br><span class="line">$ export FLASK_ENV&#x3D;development</span><br><span class="line">$ flask run</span><br><span class="line"> * Running on http:&#x2F;&#x2F;127.0.0.1:5000&#x2F;</span><br></pre></td></tr></table></figure><p>命令行运行方式： 指定DEBUG模式(指定 <code>export FLASK_ENV=development</code> 即开启debug模式，或者直接指定 <code>export FLASK_DEBUG=1</code> )</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ export FLASK_APP&#x3D;hello.py</span><br><span class="line">$ export FLASK_DEBUG&#x3D;1</span><br><span class="line">$ flask run</span><br><span class="line"> * Running on http:&#x2F;&#x2F;127.0.0.1:5000&#x2F;</span><br></pre></td></tr></table></figure><h3 id="脚本运行"><a href="#脚本运行" class="headerlink" title="脚本运行"></a>脚本运行</h3><p>编辑 <code>app.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> autoapp <span class="keyword">import</span> create_app</span><br><span class="line"></span><br><span class="line">app = create_app(<span class="string">'settings.Dev'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><p>运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python app.py</span><br><span class="line"> * Running on http:&#x2F;&#x2F;127.0.0.1:5000&#x2F;</span><br></pre></td></tr></table></figure><h2 id="工厂模式下环境自由切换"><a href="#工厂模式下环境自由切换" class="headerlink" title="工厂模式下环境自由切换"></a>工厂模式下环境自由切换</h2><p>在工厂模式(create_app)下, 怎么实现 development｜production｜test 三种环境下配置的自由切换呢？</p><p>首先工厂模式下应该存在这3个文件:</p><ul><li>app.py: 创建app实例的文件</li><li>autoapp.py: 存放工厂函数</li><li>settings.py: 存放系统配置</li></ul><p>下面直接看代码：</p><p>settings.py</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">""</span><span class="string">"Application configuration.</span></span><br><span class="line"><span class="string">"</span><span class="string">""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Config(object):</span><br><span class="line">    <span class="comment"># Base settings ###############################################</span></span><br><span class="line">    DEBUG = False</span><br><span class="line">    TESTING = False</span><br><span class="line">    SECRET_KEY = <span class="string">"it-is-secret"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Log #########################################################</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Database ####################################################</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Pro(Config):</span><br><span class="line">    ENV = <span class="string">"production"</span></span><br><span class="line">    <span class="comment"># Log #########################################################</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Database ####################################################</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Dev(Config):</span><br><span class="line">    DEBUG = True</span><br><span class="line">    ENV = <span class="string">"development"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Log #########################################################</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Database ####################################################</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Test(Config):</span><br><span class="line">    TESTING = True</span><br><span class="line">    DEBUG = True</span><br><span class="line">    ENV = <span class="string">"test"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Log #########################################################</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Database ####################################################</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>autoapp.py</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line"></span><br><span class="line">def create_app(config):</span><br><span class="line">    <span class="string">""</span><span class="string">"Create application factory, </span></span><br><span class="line"><span class="string">    as explained here: http://flask.pocoo.org/docs/patterns/appfactories/.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param config: The configuration object to use.</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line"></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_object(config)</span><br><span class="line">    <span class="built_in">return</span> app</span><br></pre></td></tr></table></figure><p>app.py</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">""</span><span class="string">"Create an application instance."</span><span class="string">""</span></span><br><span class="line">from autoapp import create_app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"development"</span>:</span><br><span class="line">    app = create_app(<span class="string">"settings.Dev"</span>)</span><br><span class="line"><span class="keyword">elif</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"production"</span>:</span><br><span class="line">    app = create_app(<span class="string">"settings.Pro"</span>)</span><br><span class="line"><span class="keyword">elif</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"test"</span>:</span><br><span class="line">    app = create_app(<span class="string">"settings.Test"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    raise EnvironmentError(<span class="string">"Please set FLASK_ENV ！！！"</span>)</span><br></pre></td></tr></table></figure><p>运行Flask</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ export FLASK_APP&#x3D;app:app</span><br><span class="line">$ export FLASK_ENV&#x3D;development</span><br><span class="line">$ flask run -p 8000</span><br><span class="line"> * Serving Flask app &quot;app:app&quot; (lazy loading)</span><br><span class="line"> * Environment: development</span><br><span class="line"> * Debug mode: on</span><br><span class="line"> * Running on http:&#x2F;&#x2F;127.0.0.1:8000&#x2F; (Press CTRL+C to quit)</span><br><span class="line"> * Restarting with stat</span><br><span class="line"> * Debugger is active!</span><br><span class="line"> * Debugger PIN: 118-853-556</span><br></pre></td></tr></table></figure><p>未指定FLASK_EN运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ flask run</span><br><span class="line"> * Environment: production</span><br><span class="line">   WARNING: This is a development server. Do not use it in a production deployment.</span><br><span class="line">   Use a production WSGI server instead.</span><br><span class="line"> * Debug mode: off</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">    ......</span><br><span class="line">    ......</span><br><span class="line">    raise EnvironmentError(&quot;Please set FLASK_ENV ！！！&quot;)</span><br><span class="line">OSError: Please set FLASK_ENV ！！！</span><br></pre></td></tr></table></figure><p>生产环境使用gunicorn运行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export FLASK_ENV&#x3D;production &amp;&amp; gunicorn app:app -c gunicorn.conf.py</span><br></pre></td></tr></table></figure><p><strong>注意：命令行方式执行都是在<code>linux</code>环境下，<code>windows</code>环境下命令可能稍微不同，将<code>export</code>换成<code>set</code>即可。</strong></p><p>Enjoy your code.</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
