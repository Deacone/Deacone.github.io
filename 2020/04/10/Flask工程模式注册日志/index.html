<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="baidu-site-verification" content="1EB8XoOl0C"><meta name="google-site-verification" content="K7thEgdLm0UfRWJ5MGdF7sCcjClSzAlxFLPv2Oz5CGM"><title> Flask 工厂模式注册初始化logger · Deacone</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="description" content="Flask 工厂模式注册初始化logger - Deacone"><meta name="keywords" content="Deacone,Flask,Python"><meta name="author" content="Deacone"><link rel="short icon" href="/images/favicon.ico"><link rel="stylesheet" href="/css/bubuzou.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Deacone"><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Deacone" type="application/atom+xml">
</head><body><header><div class="header row"> <a href="/" class="logo-link"><img src="/images/logo.png"></a><ul id="nav_list" class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" data-hover="博文" class="nav-list-link">博文</a></li><li class="nav-list-item"><a href="/archives/" target="_self" data-hover="归档" class="nav-list-link">归档</a></li><li class="nav-list-item"><a href="/about/" target="_self" data-hover="关于" class="nav-list-link">关于</a></li></ul><div class="search"><a id="search_btn" href="#search"></a></div><div id="nav_btn" class="nav-btn"><span></span><span></span><span></span></div></div></header><div class="row scroll-con"><section class="container"><!-- for archive page--><div id="postAr" class="post"><article class="post-block"><h1 class="post-title">Flask 工厂模式注册初始化logger</h1><div class="post-info">2020-04-10<p class="visit"><i data-identity="2020/04/10/Flask工程模式注册日志/" class="article-timer"></i><span>次访问</span></p></div><div class="post-content"><h4 id="工厂模式的意义"><a href="#工厂模式的意义" class="headerlink" title="工厂模式的意义"></a>工厂模式的意义</h4><p>引用官方解释：</p>
<blockquote>
<p>If you are already using packages and blueprints for your application     (Modular Applications with Blueprints) there are a couple of really nice ways to further improve the experience. A common pattern is creating the application object when the blueprint is imported. But if you move the creation of this object into a function, you can then create multiple instances of this app later.  </p>
<p>So why would you want to do this?</p>
<ol>
<li>Testing. You can have instances of the application with different settings to test every case.  </li>
<li>Multiple instances. Imagine you want to run different versions of the same application. Of course you could have multiple instances with different configs set up in your webserver, but if you use factories, you can have multiple instances of the same application running in the same application process which can be handy.</li>
</ol>
</blockquote>
<p>大概意思是：</p>
<ol>
<li>为了方便测试，你可以随心所欲的切换不同的配置实例来测试你的用例。</li>
<li>相同的应用，你可以利用不同的配置实例来进行初始化，达到运行不同版本应用的目的。</li>
</ol>
<p>官方实例的应用(autoapp.py)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">(config_filename)</span>:</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_pyfile(config_filename)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> yourapplication.model <span class="keyword">import</span> db</span><br><span class="line">    db.init_app(app)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> yourapplication.views.admin <span class="keyword">import</span> admin</span><br><span class="line">    <span class="keyword">from</span> yourapplication.views.frontend <span class="keyword">import</span> frontend</span><br><span class="line">    app.register_blueprint(admin)</span><br><span class="line">    app.register_blueprint(frontend)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br></pre></td></tr></table></figure>

<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>为了能让我们的日志初始化添加如下代码(autoapp.py)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_logging</span><span class="params">(app)</span>:</span></span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_PATH"</span>, <span class="string">"application.log"</span>)</span><br><span class="line"></span><br><span class="line">    log_formatter = <span class="string">"%(asctime)s [%(thread)d:%(threadName)s] %(filename)s:%(module)s:%(funcName)s in %(lineno)d] [%(levelname)s]: %(message)s"</span></span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_FORMATTER"</span>, log_formatter)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_MAX_BYTES"</span>, <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_BACKUP_COUNT"</span>, <span class="number">10</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_INTERVAL"</span>, <span class="number">1</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_WHEN"</span>, <span class="string">"D"</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_LEVEL"</span>, <span class="string">"INFO"</span>)</span><br><span class="line"></span><br><span class="line">    formatter = logging.Formatter(app.config[<span class="string">"LOG_FORMATTER"</span>])</span><br><span class="line">    <span class="comment"># 将日志输出到文件</span></span><br><span class="line">    <span class="comment"># 指定间隔时间自动生成文件的处理器</span></span><br><span class="line">    <span class="comment"># 实例化TimedRotatingFileHandler</span></span><br><span class="line">    <span class="comment"># interval是时间间隔，</span></span><br><span class="line">    <span class="comment"># backupCount是备份文件的个数，如果超过这个个数，就会自动删除</span></span><br><span class="line">    <span class="comment"># when是间隔的时间单位，单位有以下几种：</span></span><br><span class="line">    <span class="comment"># S 秒</span></span><br><span class="line">    <span class="comment"># M 分</span></span><br><span class="line">    <span class="comment"># H 小时、</span></span><br><span class="line">    <span class="comment"># D 天、</span></span><br><span class="line">    <span class="comment"># W 每星期（interval==0时代表星期一）</span></span><br><span class="line">    <span class="comment"># midnight 每天凌晨</span></span><br><span class="line">    timed_rotating_file_handler = TimedRotatingFileHandler(</span><br><span class="line">        filename=app.config[<span class="string">"LOG_PATH"</span>],</span><br><span class="line">        interval=app.config[<span class="string">"LOG_INTERVAL"</span>],</span><br><span class="line">        when=app.config[<span class="string">"LOG_WHEN"</span>],</span><br><span class="line">        backupCount=app.config[<span class="string">"LOG_BACKUP_COUNT"</span>],</span><br><span class="line">        encoding=<span class="string">"utf-8"</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    timed_rotating_file_handler.setFormatter(formatter)  <span class="comment"># 设置文件里写入的格式</span></span><br><span class="line">    timed_rotating_file_handler.setLevel(app.config[<span class="string">"LOG_LEVEL"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># StreamHandler</span></span><br><span class="line">    stream_handler = StreamHandler()</span><br><span class="line">    stream_handler.setFormatter(formatter)</span><br><span class="line">    stream_handler.setLevel(app.config[<span class="string">"LOG_LEVEL"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SMTPHandler</span></span><br><span class="line">    mail_handler = DelaySMTPHandler(</span><br><span class="line">        mailhost=app.config[<span class="string">"MAILHOST"</span>],</span><br><span class="line">        credentials=app.config[<span class="string">"CREDENTIALS"</span>],</span><br><span class="line">        fromaddr=app.config[<span class="string">"FROMADDR"</span>],</span><br><span class="line">        toaddrs=app.config[<span class="string">"TOADDRS"</span>],</span><br><span class="line">        subject=app.config[<span class="string">"SUBJECT"</span>],</span><br><span class="line">    )</span><br><span class="line">    mail_handler.setLevel(logging.ERROR)</span><br><span class="line">    mail_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除默认的handler</span></span><br><span class="line">    <span class="comment"># app.logger.removeHandler(default_handler)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置logger</span></span><br><span class="line">    <span class="keyword">for</span> logger <span class="keyword">in</span> (</span><br><span class="line">        app.logger,</span><br><span class="line">        logging.getLogger(<span class="string">"sqlalchemy"</span>),</span><br><span class="line">        logging.getLogger(<span class="string">"werkzeug"</span>),</span><br><span class="line">    ):</span><br><span class="line">        logger.addHandler(stream_handler)</span><br><span class="line">        logger.addHandler(timed_rotating_file_handler)</span><br><span class="line">        <span class="keyword">if</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"production"</span>:</span><br><span class="line">            logger.addHandler(mail_handler)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set logger for elk</span></span><br><span class="line">    <span class="comment"># stash_handler = logstash.LogstashHandler(</span></span><br><span class="line">    <span class="comment">#     app.config.get('ELK_HOST'),</span></span><br><span class="line">    <span class="comment">#     app.config.get('ELK_PORT')</span></span><br><span class="line">    <span class="comment"># )</span></span><br><span class="line">    <span class="comment"># root_logger.addHandler(stashHandler)</span></span><br></pre></td></tr></table></figure>

<h4 id="使用log"><a href="#使用log" class="headerlink" title="使用log"></a>使用log</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from flask import current_app</span><br><span class="line"></span><br><span class="line">current_app.logger.info(&quot;hello world&quot;)</span><br></pre></td></tr></table></figure>

<h4 id="这样做的好处"><a href="#这样做的好处" class="headerlink" title="这样做的好处"></a>这样做的好处</h4><ol>
<li>可以多环境随意切换配置，而不用更改代码</li>
<li>日志配置在<code>setting.py</code>统一配置管理</li>
</ol>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h4><p>autoapp.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_app</span><span class="params">(config_filename)</span>:</span></span><br><span class="line">    app = Flask(__name__)</span><br><span class="line">    app.config.from_pyfile(config_filename)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> yourapplication.model <span class="keyword">import</span> db</span><br><span class="line">    db.init_app(app)</span><br><span class="line">    </span><br><span class="line">    register_logging(app)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">from</span> yourapplication.views.admin <span class="keyword">import</span> admin</span><br><span class="line">    <span class="keyword">from</span> yourapplication.views.frontend <span class="keyword">import</span> frontend</span><br><span class="line">    app.register_blueprint(admin)</span><br><span class="line">    app.register_blueprint(frontend)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register_logging</span><span class="params">(app)</span>:</span></span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_PATH"</span>, <span class="string">"application.log"</span>)</span><br><span class="line"></span><br><span class="line">    log_formatter = <span class="string">"%(asctime)s [%(thread)d:%(threadName)s] %(filename)s:%(module)s:%(funcName)s in %(lineno)d] [%(levelname)s]: %(message)s"</span></span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_FORMATTER"</span>, log_formatter)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_MAX_BYTES"</span>, <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_BACKUP_COUNT"</span>, <span class="number">10</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_INTERVAL"</span>, <span class="number">1</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_WHEN"</span>, <span class="string">"D"</span>)</span><br><span class="line">    app.config.setdefault(<span class="string">"LOG_LEVEL"</span>, <span class="string">"INFO"</span>)</span><br><span class="line"></span><br><span class="line">    formatter = logging.Formatter(app.config[<span class="string">"LOG_FORMATTER"</span>])</span><br><span class="line">    <span class="comment"># 将日志输出到文件</span></span><br><span class="line">    <span class="comment"># 指定间隔时间自动生成文件的处理器</span></span><br><span class="line">    <span class="comment"># 实例化TimedRotatingFileHandler</span></span><br><span class="line">    <span class="comment"># interval是时间间隔，</span></span><br><span class="line">    <span class="comment"># backupCount是备份文件的个数，如果超过这个个数，就会自动删除</span></span><br><span class="line">    <span class="comment"># when是间隔的时间单位，单位有以下几种：</span></span><br><span class="line">    <span class="comment"># S 秒</span></span><br><span class="line">    <span class="comment"># M 分</span></span><br><span class="line">    <span class="comment"># H 小时、</span></span><br><span class="line">    <span class="comment"># D 天、</span></span><br><span class="line">    <span class="comment"># W 每星期（interval==0时代表星期一）</span></span><br><span class="line">    <span class="comment"># midnight 每天凌晨</span></span><br><span class="line">    timed_rotating_file_handler = TimedRotatingFileHandler(</span><br><span class="line">        filename=app.config[<span class="string">"LOG_PATH"</span>],</span><br><span class="line">        interval=app.config[<span class="string">"LOG_INTERVAL"</span>],</span><br><span class="line">        when=app.config[<span class="string">"LOG_WHEN"</span>],</span><br><span class="line">        backupCount=app.config[<span class="string">"LOG_BACKUP_COUNT"</span>],</span><br><span class="line">        encoding=<span class="string">"utf-8"</span>,</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    timed_rotating_file_handler.setFormatter(formatter)  <span class="comment"># 设置文件里写入的格式</span></span><br><span class="line">    timed_rotating_file_handler.setLevel(app.config[<span class="string">"LOG_LEVEL"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># StreamHandler</span></span><br><span class="line">    stream_handler = StreamHandler()</span><br><span class="line">    stream_handler.setFormatter(formatter)</span><br><span class="line">    stream_handler.setLevel(app.config[<span class="string">"LOG_LEVEL"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SMTPHandler</span></span><br><span class="line">    mail_handler = DelaySMTPHandler(</span><br><span class="line">        mailhost=app.config[<span class="string">"MAILHOST"</span>],</span><br><span class="line">        credentials=app.config[<span class="string">"CREDENTIALS"</span>],</span><br><span class="line">        fromaddr=app.config[<span class="string">"FROMADDR"</span>],</span><br><span class="line">        toaddrs=app.config[<span class="string">"TOADDRS"</span>],</span><br><span class="line">        subject=app.config[<span class="string">"SUBJECT"</span>],</span><br><span class="line">    )</span><br><span class="line">    mail_handler.setLevel(logging.ERROR)</span><br><span class="line">    mail_handler.setFormatter(formatter)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除默认的handler</span></span><br><span class="line">    <span class="comment"># app.logger.removeHandler(default_handler)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置logger</span></span><br><span class="line">    <span class="keyword">for</span> logger <span class="keyword">in</span> (</span><br><span class="line">        app.logger,</span><br><span class="line">        logging.getLogger(<span class="string">"sqlalchemy"</span>),</span><br><span class="line">        logging.getLogger(<span class="string">"werkzeug"</span>),</span><br><span class="line">    ):</span><br><span class="line">        logger.addHandler(stream_handler)</span><br><span class="line">        logger.addHandler(timed_rotating_file_handler)</span><br><span class="line">        <span class="keyword">if</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"production"</span>:</span><br><span class="line">            logger.addHandler(mail_handler)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># set logger for elk</span></span><br><span class="line">    <span class="comment"># stash_handler = logstash.LogstashHandler(</span></span><br><span class="line">    <span class="comment">#     app.config.get('ELK_HOST'),</span></span><br><span class="line">    <span class="comment">#     app.config.get('ELK_PORT')</span></span><br><span class="line">    <span class="comment"># )</span></span><br><span class="line">    <span class="comment"># root_logger.addHandler(stashHandler)</span></span><br></pre></td></tr></table></figure>

<p>settings.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""Application configuration.</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">BASE_DIR = os.path.dirname(__file__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="comment"># Base settings #################################################</span></span><br><span class="line">    DEBUG = <span class="literal">False</span></span><br><span class="line">    TESTING = <span class="literal">False</span></span><br><span class="line">    SECRET_KEY = <span class="string">""</span></span><br><span class="line">    BUNDLE_ERRORS = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志配置 ###############################################################</span></span><br><span class="line">    LOG_PATH = os.path.join(BASE_DIR, <span class="string">"logs"</span>, <span class="string">"falling-wind-service.log"</span>)</span><br><span class="line">    LOG_FORMATTER = (</span><br><span class="line">        <span class="string">"%(asctime)s [%(name)s] [%(thread)d:%(threadName)s] "</span></span><br><span class="line">        <span class="string">"%(filename)s:%(module)s:%(funcName)s "</span></span><br><span class="line">        <span class="string">"in %(lineno)d] "</span></span><br><span class="line">        <span class="string">"[%(levelname)s]: %(message)s"</span></span><br><span class="line">    )</span><br><span class="line">    LOG_MAX_BYTES = <span class="number">50</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 日志文件大小</span></span><br><span class="line">    LOG_BACKUP_COUNT = <span class="number">10</span>  <span class="comment"># 备份文件数量</span></span><br><span class="line">    LOG_INTERVAL = <span class="number">1</span></span><br><span class="line">    LOG_WHEN = <span class="string">"D"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 数据库配置 ####################################################</span></span><br><span class="line">    SQLALCHEMY_ENGINE_OPTIONS = &#123;</span><br><span class="line">        <span class="string">"pool_timeout"</span>: <span class="number">10</span>,  <span class="comment"># 默认链接超时时长</span></span><br><span class="line">        <span class="string">"pool_size"</span>: <span class="number">10</span>,  <span class="comment"># 数据库链接池大小</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 提供多库链接 使用其他库进行链接的时候需要使用bind指定那个库使用</span></span><br><span class="line">    SQLALCHEMY_BINDS = &#123;&#125;</span><br><span class="line">    SQLALCHEMY_TRACK_MODIFICATIONS = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Celery ##################################################################</span></span><br><span class="line">    enable_utc = <span class="literal">True</span></span><br><span class="line">    timezone = <span class="string">"Asia/Shanghai"</span></span><br><span class="line">    <span class="comment"># or the actual content-type (MIME)</span></span><br><span class="line">    accept_content = [<span class="string">"application/json"</span>]</span><br><span class="line">    <span class="comment"># or the actual content-type (MIME)</span></span><br><span class="line">    result_accept_content = [<span class="string">"application/json"</span>]</span><br><span class="line">    include = [<span class="string">"app_tasks.user_tasks"</span>]</span><br><span class="line">    result_expires = <span class="number">3600</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># JWT ####################################################################</span></span><br><span class="line">    JWT_SECRET_KEY = <span class="string">""</span></span><br><span class="line">    <span class="comment"># JWT_BLACKLIST_ENABLED = False</span></span><br><span class="line">    <span class="comment"># JWT_BLACKLIST_TOKEN_CHECKS = ['access', 'refresh']</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pro</span><span class="params">(Config)</span>:</span></span><br><span class="line">    ENV = <span class="string">"product"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志 ##################################################################</span></span><br><span class="line">    LOG_PATH = <span class="string">"your application log path"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># DB ##################################################################</span></span><br><span class="line">    DB_HOST = <span class="string">""</span></span><br><span class="line">    DB_PORT = <span class="number">3306</span></span><br><span class="line">    DB_DATABASE = <span class="string">""</span></span><br><span class="line">    DB_USER = <span class="string">""</span></span><br><span class="line">    DB_PASSWORD = <span class="string">""</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = <span class="string">"mysql+pymysql://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;"</span>.format(</span><br><span class="line">        DB_USER, DB_PASSWORD, DB_HOST, DB_PORT, DB_DATABASE</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Redis ####################################################</span></span><br><span class="line">    REDIS_URL = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Mail ########################################################</span></span><br><span class="line">    MAIL_SERVER = <span class="string">"smtp.qq.com"</span></span><br><span class="line">    MAIL_PORT = <span class="number">465</span></span><br><span class="line">    MAIL_USE_SSL = <span class="literal">True</span></span><br><span class="line">    MAIL_USERNAME = <span class="string">""</span></span><br><span class="line">    MAIL_PASSWORD = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Celery ###########################################################</span></span><br><span class="line">    <span class="comment"># Broker settings.</span></span><br><span class="line">    broker_url = <span class="string">""</span></span><br><span class="line">    <span class="comment"># Using the redis to store task state and results.</span></span><br><span class="line">    result_backend = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># JWT ###############################################################</span></span><br><span class="line">    <span class="comment"># JWT_ACCESS_TOKEN_EXPIRES = 60 * 60</span></span><br><span class="line">    JWT_SECRET_KEY = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># SMTPHandler ######################################################</span></span><br><span class="line">    MAILHOST = (<span class="string">"smtp.qq.com"</span>, <span class="number">465</span>)</span><br><span class="line">    CREDENTIALS = (<span class="string">""</span>, <span class="string">""</span>)</span><br><span class="line">    FROMADDR = <span class="string">""</span></span><br><span class="line">    TOADDRS = [<span class="string">""</span>]</span><br><span class="line">    SUBJECT = <span class="string">""</span></span><br><span class="line">    SECURE = (<span class="string">"SSL"</span>,)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dev</span><span class="params">(Config)</span>:</span></span><br><span class="line">    DEBUG = <span class="literal">True</span></span><br><span class="line">    ENV = <span class="string">"dev"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日志 ##################################################################</span></span><br><span class="line">    LOG_PATH = <span class="string">"your path"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># DB ####################################################################</span></span><br><span class="line">    DB_HOST = <span class="string">"localhost"</span></span><br><span class="line">    DB_PORT = <span class="number">3306</span></span><br><span class="line">    DB_DATABASE = <span class="string">""</span></span><br><span class="line">    DB_USER = <span class="string">""</span></span><br><span class="line">    DB_PASSWORD = <span class="string">""</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = <span class="string">"mysql+pymysql://&#123;&#125;:&#123;&#125;@&#123;&#125;:&#123;&#125;/&#123;&#125;"</span>.format(</span><br><span class="line">        DB_USER, DB_PASSWORD, DB_HOST, DB_PORT, DB_DATABASE</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Redis ####################################################</span></span><br><span class="line">    REDIS_URL = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Mail ########################################################</span></span><br><span class="line">    MAIL_SERVER = <span class="string">"smtp.qq.com"</span></span><br><span class="line">    MAIL_PORT = <span class="number">25</span></span><br><span class="line">    MAIL_USE_TLS = <span class="literal">True</span></span><br><span class="line">    MAIL_USERNAME = <span class="string">""</span></span><br><span class="line">    MAIL_PASSWORD = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Celery ###################################################################</span></span><br><span class="line">    <span class="comment"># Broker settings.</span></span><br><span class="line">    broker_url = <span class="string">""</span></span><br><span class="line">    <span class="comment"># Using the redis to store task state and results.</span></span><br><span class="line">    result_backend = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># JWT ###############################################################</span></span><br><span class="line">    JWT_ACCESS_TOKEN_EXPIRES = <span class="number">60</span> * <span class="number">60</span></span><br><span class="line">    JWT_SECRET_KEY = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># SMTPHandler ######################################################</span></span><br><span class="line">    MAILHOST = (<span class="string">"smtp.qq.com"</span>, <span class="number">465</span>)</span><br><span class="line">    CREDENTIALS = (<span class="string">""</span>, <span class="string">""</span>)</span><br><span class="line">    FROMADDR = <span class="string">""</span></span><br><span class="line">    TOADDRS = [<span class="string">""</span>]</span><br><span class="line">    SUBJECT = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">(Config)</span>:</span></span><br><span class="line">    TESTING = <span class="literal">True</span></span><br><span class="line">    DEBUG = <span class="literal">True</span></span><br><span class="line">    ENV = <span class="string">"test"</span></span><br></pre></td></tr></table></figure>

<p>app.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">"""Create an application instance."""</span></span><br><span class="line"><span class="keyword">from</span> autoapp <span class="keyword">import</span> create_app</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> extensions <span class="keyword">import</span> celery</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"development"</span>:</span><br><span class="line">    app = create_app(<span class="string">"settings.Dev"</span>)</span><br><span class="line"><span class="keyword">elif</span> os.getenv(<span class="string">"FLASK_ENV"</span>) == <span class="string">"production"</span>:</span><br><span class="line">    app = create_app(<span class="string">"settings.Pro"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> EnvironmentError(<span class="string">"Please set FLASK_ENV ！！！"</span>)</span><br><span class="line"></span><br><span class="line">celery = celery</span><br></pre></td></tr></table></figure>

<h4 id="运行flask"><a href="#运行flask" class="headerlink" title="运行flask"></a>运行flask</h4><p>windows</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ set FLASK_ENV&#x3D;development</span><br><span class="line">$ flask run</span><br></pre></td></tr></table></figure>

<p>Linux</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ export FLASK_ENV&#x3D;development</span><br><span class="line">$ flask run</span><br></pre></td></tr></table></figure>

<p>Enjoy your code!</p>
</div></article></div><div class="right-container"><div class="widget"><div id="arAnchorBar"></div></div></div></section></div><div class="right-menu"></div><div class="modal search-modal"><div class="input-field"><input type="text" id="search_input"><label for="search-input">搜索</label></div><div id="search_result" class="search-result"></div></div><div class="blog-overlay"></div><footer class="row"><div class="footer-con"><div class="paginator"><a href="/2020/04/10/ELKF%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%80%BB%E7%BB%93/" title="ELK 环境搭建" class="prev">PREV</a></div><a href="#comment" class="comment-anchor"></a><div id="vcomments"></div><script>new Valine({
    el: "#vcomments",
    appId: "aD8jJBpu4oew3ovNY73z6Rdq-gzGzoHsz",
    appKey: "FdzS5SOPHdhYQoEUngQ8K2QW",
    notify: false,
    verify: false,
    avatar: "robohash",
    visitor: true,
    placeholder: "随便说点什么～.～",
});</script><div class="copyright"><p>© 2020 <a target="_blank">Deacone</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <br> and <a href="https://github.com/Bulandent/hexo-theme-bubuzou" target="_blank">hexo-theme-bubuzou</a></p><p> <span style="padding-right: 6px;">闽ICP备16007301号-2</span></p></div><div class="totop"><i></i></div></div></footer><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script src="/scripts/jquery-1.8.2.min.js"></script><script src="/scripts/ar-anchor.js"></script><script src="/scripts/main.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>const valineAPI = (() => {
try {
    AV.init("aD8jJBpu4oew3ovNY73z6Rdq-gzGzoHsz", "FdzS5SOPHdhYQoEUngQ8K2QW");
} catch(error) {}
const isExist = (identity) => {
    identity = identity || getRealPath();
    let query = new AV.Query('Timer');
    return new Promise((resolve, reject) => {
    query.equalTo("identity", identity);
    query.find().then(results => {
        resolve(results.length > 0);
    }, error => reject(error));
    })
}

const _get = (identity) => {
    let query = null;
    if(identity && identity instanceof Array){
    let querys = [];
    for(let i = 0; i < identity.length; ++i) {
        querys[i] = new AV.Query('Timer');
        querys[i].equalTo('identity', identity[i]);
    }
    query = AV.Query.or.apply(null ,querys);
    } else {
    identity = identity || getRealPath();
    query = new AV.Query("Timer");
    query.equalTo("identity", identity);
    }

    return new Promise((resolve, reject) => {
    query.find()
    .then(results => resolve(results))
    .catch(error => reject(error))
    })
}

const create = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
    let Todo = AV.Object.extend('Timer');
    let todo = new Todo();
    todo.set("times", 1);
    todo.set("identity", identity);
    todo.save().then(res => resolve(true), error => reject(error));
    })
}

const update = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
    let query = new AV.Query('Timer');
    query.equalTo("identity", identity);
    query.find().then(todos => {
        todos.forEach(todo => {
        todo.set("times", todo.attributes.times + 1);
        });
        return AV.Object.saveAll(todos);
    }).then(todos => resolve(true), error => reject(error));
    })
}

return {
    isExist,
    _get,
    update,
    create
}
})()

const calcAndWriteTimes = () => {
let isPost = true;

let timerAllDOM = document.querySelectorAll(".article-timer");

if(isPost) {
    let identity = timerAllDOM[0].getAttribute("data-identity");
    valineAPI.isExist(identity)
    .then(exist => {
    if(exist) {
        return valineAPI.update(identity);
    }
    return new Promise(resolve => resolve(true));
    })
    .then( succuess => valineAPI._get(identity))
    .then( result => timerAllDOM[0].innerText = result[0].attributes.times)
    .catch(error => console.log(error.message))
    return ;
}

let timerDOMCache = {};

for(let timerDOM of timerAllDOM) {
    let identity = timerDOM.getAttribute("data-identity");
    if(timerDOMCache.hasOwnProperty(identity)){
    timerDOMCache[identity].dom.push(timerDOM);
    }else{
    timerDOMCache[identity] = {
        dom: [timerDOM],
        times: undefined
    };
    }
}

let identities = Object.keys(timerDOMCache);
valineAPI._get(identities).then(results => {
    for(let result of results) {
    let {identity, times} = result.attributes;
    timerDOMCache[identity].times = times;
    timerDOMCache[identity].dom.map(item => item.innerText = times);
    }
    for(let identity of identities) {
    if(timerDOMCache[identity].times){
        continue;
    }
    timerDOMCache[identity].dom.map(item => item.innerText = 1);
    valineAPI.create(identity);
    }
}).catch(error => console.log(error.message))
}

if(true){
calcAndWriteTimes();
}</script></body></html>